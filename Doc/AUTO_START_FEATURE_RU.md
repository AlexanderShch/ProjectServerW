# Функция автоматического запуска по времени

## Дата добавления
29 октября 2025

## Описание

Добавлена возможность автоматического запуска программы контроллера в заданное время.

---

## ?? Назначение

Функция позволяет настроить время, когда автоматически будет отправлена команда **START** контроллеру без участия оператора.

### Применение:
- Автоматический запуск дефростера в определенное время
- Плановые операции по расписанию
- Снижение человеческого фактора
- Точное соблюдение графика работы

---

## ?? Элементы интерфейса

На вкладке **"Настройки"** добавлены новые элементы:

### 1. Label "Автозапуск в:"
- Расположение: под кнопками ПУСК/СТОП
- Показывает статус автозапуска цветом:
  - Черный - отключен
  - Зеленый - включен, ожидает времени
  - Синий - сработал автозапуск

### 2. CheckBox "Включен"
- Включает/выключает функцию автозапуска
- При включении запускается таймер проверки времени
- При выключении таймер останавливается

### 3. DateTimePicker (выбор времени)
- Формат: **HH:mm** (часы:минуты, без секунд)
- Тип: Custom (пользовательский формат)
- Позволяет выбрать время срабатывания
- Доступен всегда для изменения
- **Примечание:** Секунды не указываются, проверка идет только по часам и минутам

---

## ?? Как это работает

### Алгоритм работы:

```
1. Пользователь устанавливает время (например, 08:00)
2. Включает CheckBox "Включен"
3. Запускается таймер проверки (каждые 30 секунд)
4. При совпадении текущего времени с заданным:
   ?? Проверяется, доступна ли кнопка START
   ?? Если ДА: отправляется команда START
   ?  ?? Логируется событие
   ?  ?? Отображается сообщение
   ?  ?? Автозапуск автоматически отключается
   ?? Если НЕТ (программа уже запущена):
      ?? Логируется предупреждение
      ?? Отображается сообщение
      ?? Автозапуск автоматически отключается
```

---

## ?? Пример использования

### Сценарий: Запуск дефростера в 8:00 утра

1. **Настройка (выполняется заранее):**
   ```
   - Открыть вкладку "Настройки"
   - В поле времени установить: 08:00
   - Поставить галочку "Включен"
   - Надпись "Автозапуск в:" станет зеленой
   ```

2. **Автоматическая работа:**
   ```
   07:59:00 - Система ждет
   07:59:30 - Проверка времени (не совпало)
   08:00:00 - Проверка времени (СОВПАЛО!)
   08:00:01 - Отправка команды START
   08:00:02 - Программа контроллера запущена
   08:00:03 - Автозапуск автоматически отключен
   ```

3. **Логирование:**
   ```
   [07:55:00] Information: Автозапуск включен на 08:00
   [08:00:00] Information: Автозапуск сработал в 08:00:00
   [08:00:01] Information: Команда START успешно выполнена контроллером
   ```

---

## ?? Защитные механизмы

### 1. Проверка состояния программы
```cpp
if (buttonSTART->Enabled) {
    // Программа НЕ запущена - можно стартовать
    SendStartCommand();
} else {
    // Программа УЖЕ запущена - пропускаем
    LogWarning("Автозапуск пропущен - программа уже работает");
}
```

**Защита от:**
- Повторного запуска уже работающей программы
- Конфликтов команд

### 2. Автоматическое отключение
После срабатывания автозапуск **автоматически выключается**:
```cpp
checkBoxAutoStart->Checked = false;
```

**Защита от:**
- Повторного срабатывания на следующий день
- Случайного запуска

### 3. Интервал проверки
Таймер проверяет время каждые **30 секунд**:
```cpp
timerAutoStart->Interval = 30000; // 30 секунд
```

**Преимущества:**
- Минимальная нагрузка на систему
- Точность ±30 секунд (достаточно для большинства задач)
- Не мешает основной работе

---

## ?? Логирование

### События, которые логируются:

1. **Включение автозапуска:**
   ```
   Information: Автозапуск включен на 08:00
   ```

2. **Отключение автозапуска:**
   ```
   Information: Автозапуск отключен
   ```

3. **Срабатывание автозапуска:**
   ```
   Information: Автозапуск сработал в 08:00:00
   Information: Команда START успешно выполнена контроллером
   ```

4. **Пропуск (программа уже запущена):**
   ```
   Warning: Автозапуск не выполнен - программа уже запущена
   ```

---

## ?? Визуальная индикация

### Цветовые индикаторы:

| Состояние | Цвет Label | Значение |
|-----------|------------|----------|
| Отключен | Черный (по умолчанию) | Автозапуск выключен |
| Включен, ожидает | Зеленый | Активен, ждет времени |
| Сработал | Синий | Команда отправлена |
| Ошибка/Пропуск | Оранжевый | Не удалось выполнить |

### Сообщения в Label_Commands:

- **При срабатывании:**
  ```
  ? Автоматический запуск программы...
  ```

- **При пропуске:**
  ```
  ? Автозапуск пропущен - программа уже работает
  ```

---

## ?? Технические детали

### Файлы:
- **DataForm.h** - объявление элементов и обработчиков

### Новые компоненты:
```cpp
private: System::Windows::Forms::CheckBox^ checkBoxAutoStart;
private: System::Windows::Forms::DateTimePicker^ dateTimePickerAutoStart;
private: System::Windows::Forms::Label^ labelAutoStart;
private: System::Windows::Forms::Timer^ timerAutoStart;
```

### Обработчики:
1. `checkBoxAutoStart_CheckedChanged()` - включение/выключение
2. `timerAutoStart_Tick()` - проверка времени
3. `RestoreAutoStartColor()` - восстановление цветов

### Таймер:
- **Интервал:** 30000 мс (30 секунд)
- **Запуск:** при включении CheckBox
- **Остановка:** при выключении CheckBox

---

## ?? Важные замечания

### 1. Автозапуск срабатывает ОДИН раз
После срабатывания чекбокс автоматически снимается. Для повторного использования нужно заново:
- Установить время
- Поставить галочку

### 2. Точность по минутам
Таймер проверяет время каждые 30 секунд и сравнивает **только часы и минуты** (секунды игнорируются):
- **Срабатывание происходит когда совпадут часы и минуты**
- Пример: установлено 08:00, сработает в любое время с 08:00:00 до 08:00:59
- Фактическая погрешность: ±30 секунд от начала минуты (зависит от момента проверки)

### 3. Требуется активное соединение
Для отправки команды START контроллеру должно быть установлено соединение по TCP/IP.

### 4. Форма должна быть открыта
Автозапуск работает только когда форма DataForm открыта. При закрытии формы таймер останавливается.

---

## ?? Примеры использования

### Пример 1: Ежедневный запуск в 8:00
```
Действия:
1. Каждый вечер устанавливаем время 08:00
2. Включаем автозапуск
3. Закрываем программу (или оставляем работать)

Утром:
- В 08:00 программа автоматически отправит START
- Дефростер начнет работу
- Автозапуск отключится
```

### Пример 2: Плановое обслуживание
```
Действия:
1. Устанавливаем время начала обслуживания (например, 14:00)
2. Включаем автозапуск
3. Контроллер автоматически запустит программу в заданное время

Результат:
- Точное соблюдение графика
- Исключен человеческий фактор
```

---

## ?? Checklist перед использованием

- ? Контроллер подключен по TCP/IP
- ? Соединение установлено (клиент подключен)
- ? Кнопка START доступна (программа не запущена)
- ? Время установлено корректно
- ? CheckBox "Включен" отмечен
- ? Надпись "Автозапуск в:" зеленого цвета

---

## ?? Устранение проблем

### Проблема: Автозапуск не сработал

**Возможные причины:**
1. CheckBox не включен
2. Программа уже была запущена
3. Нет соединения с контроллером
4. Форма была закрыта

**Решение:**
- Проверьте лог на наличие сообщений об автозапуске
- Убедитесь, что чекбокс включен перед заданным временем
- Проверьте соединение с контроллером

### Проблема: Автозапуск срабатывает каждую минуту

**Причина:**
- Не должно происходить - автозапуск автоматически отключается

**Решение:**
- Если проблема повторяется, перезапустите программу
- Проверьте лог

---

## ?? Связанные документы

- `Commands.h` - команды управления контроллером
- `DataForm.h` - основная форма программы
- `ERROR_HANDLING_GUIDE.md` - обработка ошибок

---

## ?? Заключение

Функция автозапуска:
- ? Проста в использовании
- ? Безопасна (проверка состояния)
- ? Логируется
- ? Визуально индицируется
- ? Автоматически отключается после срабатывания

**Рекомендуется для автоматизации повторяющихся операций!** ??

