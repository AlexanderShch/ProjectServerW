# Руководство по обработке ошибок исполнения команд

## Дата создания: 26 октября 2025

## Обзор

В проект добавлена полноценная система обработки ошибок исполнения команд, отправляемых контроллеру. Система предоставляет детальную информацию об ошибках с рекомендациями по их устранению.

## Типы ошибок

### 1. CRC_ERROR (0x01)
**Описание**: Ошибка контрольной суммы CRC. Данные повреждены при передаче.

**Возможные причины**:
- Помехи на линии связи
- Плохое качество кабеля
- Электромагнитные наводки

**Рекомендации**:
- Проверьте качество соединения
- Проверьте экранирование кабеля
- Уменьшите скорость передачи данных

---

### 2. INVALID_TYPE (0x02)
**Описание**: Неизвестный тип команды. Контроллер не поддерживает данный тип.

**Возможные причины**:
- Устаревшая прошивка контроллера
- Несовместимость версий протокола
- Ошибка в коде отправки команды

**Рекомендации**:
- Обновите прошивку контроллера
- Проверьте совместимость версий
- Убедитесь, что команда поддерживается

---

### 3. INVALID_CODE (0x03)
**Описание**: Неизвестный код команды. Команда не реализована в контроллере.

**Возможные причины**:
- Команда не реализована в текущей версии прошивки
- Ошибка в коде команды

**Рекомендации**:
- Обновите прошивку контроллера
- Проверьте совместимость версий
- Убедитесь, что команда поддерживается

---

### 4. INVALID_LENGTH (0x04)
**Описание**: Неверная длина данных. Размер параметров не соответствует ожидаемому.

**Возможные причины**:
- Неправильные параметры команды
- Команда требует другой набор данных

**Рекомендации**:
- Проверьте параметры команды
- Команда может требовать другой набор данных

---

### 5. EXECUTION_ERROR (0x05) ??
**Описание**: Ошибка выполнения команды. Контроллер не смог выполнить операцию.

**Возможные причины**:
- Команда недоступна в текущем состоянии контроллера
- Отсутствуют необходимые условия для выполнения
- Контроллер занят другой операцией
- Аппаратная ошибка

**Рекомендации**:
- Проверьте текущее состояние контроллера
- Команда может быть недоступна в текущем режиме
- Проверьте наличие необходимых условий для выполнения
- Попробуйте выполнить команду позже

**Примеры**:
- Попытка запустить программу, которая уже запущена
- Попытка остановить программу, которая не запущена
- Попытка выполнить команду при критической ошибке контроллера

---

### 6. TIMEOUT (0x06)
**Описание**: Таймаут выполнения. Контроллер не успел выполнить операцию в отведенное время.

**Возможные причины**:
- Команда требует длительного времени выполнения
- Контроллер перегружен
- Контроллер завис

**Рекомендации**:
- Команда требует длительного выполнения
- Увеличьте таймаут ожидания
- Проверьте, не занят ли контроллер другой операцией

---

### 7. UNKNOWN_ERROR (0xFF)
**Описание**: Неизвестная ошибка. Произошла непредвиденная ошибка в контроллере.

**Возможные причины**:
- Критическая ошибка в прошивке контроллера
- Аппаратная неисправность
- Переполнение памяти

**Рекомендации**:
- Перезагрузите контроллер
- Проверьте журнал ошибок контроллера
- Обратитесь в техническую поддержку

---

## Реализованные функции

### 1. GetStatusName(uint8_t status)
Возвращает краткое англоязычное название статуса.

```cpp
const char* statusName = GetStatusName(response.status);
// Вернет: "OK", "CRC_ERROR", "EXECUTION_ERROR" и т.д.
```

### 2. GetStatusDescription(uint8_t status)
Возвращает детальное описание ошибки на русском языке.

```cpp
const char* statusDescription = GetStatusDescription(response.status);
// Вернет: "Ошибка выполнения команды. Контроллер не смог выполнить операцию"
```

### 3. ProcessResponse(const CommandResponse& response)
Обрабатывает полученный ответ от контроллера с детальной диагностикой ошибок.

**Функционал**:
- Отображает детальную информацию об ошибке
- Предоставляет специфичные рекомендации для каждого типа ошибки
- Визуально выделяет ошибки (красный цвет текста)
- Логирует все операции

**Пример использования**:
```cpp
CommandResponse response;
if (SendCommandAndWaitResponse(cmd, response)) {
    // Команда выполнена успешно
    // ProcessResponse автоматически обработал успешный ответ
} else {
    // Ошибка выполнения команды
    // ProcessResponse автоматически отобразил детальную информацию об ошибке
}
```

---

## Обработка ошибок в командах START/STOP

### SendStartCommand()

**Успешное выполнение**:
- Кнопки переключаются в состояние "Работа"
- Отображается сообщение: "? Программа запущена" (зеленый цвет)
- Логируется информация об успешном запуске

**Ошибки выполнения**:

#### EXECUTION_ERROR
```
? Невозможно запустить программу. Проверьте состояние контроллера
```
**Возможные причины**:
- Программа уже запущена
- Контроллер не готов к запуску
- Отсутствуют необходимые условия

#### TIMEOUT
```
? Таймаут запуска программы
```
**Возможные причины**:
- Контроллер не успел инициализировать запуск
- Контроллер занят другой операцией

---

### SendStopCommand()

**Успешное выполнение**:
- Кнопки переключаются в состояние "Останов"
- Отображается сообщение: "? Программа остановлена" (зеленый цвет)
- Логируется информация об успешной остановке

**Ошибки выполнения**:

#### EXECUTION_ERROR
```
? Невозможно остановить программу. Проверьте состояние контроллера
```
**Возможные причины**:
- Программа уже остановлена
- Контроллер не может остановиться из-за критического состояния

#### TIMEOUT
```
? Таймаут остановки программы
```
**Возможные причины**:
- Контроллер не успел корректно завершить работу
- Длительное сохранение данных

---

## Визуальная индикация

### Успех
- Цвет текста: **Зеленый**
- Иконка: ?
- Длительность: 3 секунды

### Предупреждение
- Цвет текста: **Оранжевый**
- Иконка: ? или ?
- Длительность: постоянно

### Ошибка
- Цвет текста: **Красный**
- Иконка: ? или ?
- Длительность: 3 секунды с автоматическим восстановлением цвета

---

## Логирование

Все операции с командами и ошибки логируются в файл `log.txt`:

### Пример успешного выполнения:
```
26.10.25 14:30:45 : Command sent successfully: 5 bytes
26.10.25 14:30:45 : Response received: Type=0x01, Code=0x01, Status=0x00
26.10.25 14:30:45 : ? Команда Type=0x01, Code=0x01 успешно выполнена
```

### Пример ошибки:
```
26.10.25 14:35:20 : Command sent successfully: 5 bytes
26.10.25 14:35:20 : Response received: Type=0x01, Code=0x01, Status=0x05
26.10.25 14:35:20 : ? ОШИБКА выполнения команды
26.10.25 14:35:20 : Команда: Type=0x01, Код=0x01
26.10.25 14:35:20 : Статус: 0x05 (EXECUTION_ERROR)
26.10.25 14:35:20 : Описание: Ошибка выполнения команды. Контроллер не смог выполнить операцию
```

---

## Примеры использования

### Пример 1: Отправка команды с обработкой ошибок

```cpp
// Создаем команду
Command cmd = CreateControlCommand(CmdProgControl::START);
CommandResponse response;

// Отправляем и ожидаем ответ
if (SendCommandAndWaitResponse(cmd, response)) {
    // Команда выполнена успешно (response.status == CmdStatus::OK)
    GlobalLogger::LogMessage("START command executed successfully");
} else {
    // Произошла ошибка
    // Детальная информация уже отображена пользователю через ProcessResponse
    
    // Дополнительная обработка специфичных ошибок
    switch (response.status) {
        case CmdStatus::EXECUTION_ERROR:
            // Специфичная обработка для EXECUTION_ERROR
            break;
        case CmdStatus::TIMEOUT:
            // Специфичная обработка для TIMEOUT
            break;
        default:
            // Общая обработка других ошибок
            break;
    }
}
```

### Пример 2: Проверка типа ошибки

```cpp
CommandResponse response;
if (!SendCommandAndWaitResponse(cmd, response)) {
    // Получаем детальную информацию об ошибке
    const char* statusName = GetStatusName(response.status);
    const char* statusDescription = GetStatusDescription(response.status);
    
    // Логируем
    GlobalLogger::LogMessage(String::Format(
        "Command failed: {0} - {1}",
        gcnew String(statusName),
        gcnew String(statusDescription)
    ));
}
```

---

## Диагностика проблем

### Контроллер не отвечает
1. Проверьте соединение (`clientSocket != INVALID_SOCKET`)
2. Проверьте, что контроллер включен
3. Проверьте настройки COM-порта
4. Посмотрите логи в `log.txt`

### Постоянные ошибки CRC
1. Проверьте качество кабеля
2. Уменьшите скорость передачи
3. Используйте экранированный кабель
4. Устраните источники помех

### Ошибки EXECUTION_ERROR
1. Проверьте текущее состояние контроллера
2. Убедитесь, что выполнены все предварительные условия
3. Проверьте последовательность команд
4. Дождитесь завершения предыдущих операций

### Постоянные TIMEOUT
1. Увеличьте таймаут в функции `ReceiveResponse`
2. Проверьте загрузку контроллера
3. Проверьте, не зависла ли прошивка контроллера
4. Перезагрузите контроллер

---

## Настройка таймаутов

Таймауты можно настроить в вызовах `ReceiveResponse`:

```cpp
// Короткий таймаут (1 секунда)
if (!ReceiveResponse(response, 1000)) {
    // Обработка таймаута
}

// Стандартный таймаут (2 секунды) - используется по умолчанию
if (!ReceiveResponse(response, 2000)) {
    // Обработка таймаута
}

// Длинный таймаут (5 секунд) - для длительных операций
if (!ReceiveResponse(response, 5000)) {
    // Обработка таймаута
}
```

---

## Рекомендации по использованию

1. **Всегда проверяйте возвращаемое значение** `SendCommandAndWaitResponse`
2. **Не игнорируйте ошибки** - они могут указывать на серьезные проблемы
3. **Логируйте все операции** - это упростит диагностику
4. **Обрабатывайте специфичные ошибки** там, где это необходимо
5. **Информируйте пользователя** о проблемах с понятными сообщениями
6. **Не повторяйте неудачные команды** слишком часто - это может перегрузить контроллер

---

## Файлы проекта

### Изменены:
- **Commands.h** - добавлена функция `GetStatusDescription()`
- **Commands.cpp** - реализована функция `GetStatusDescription()` с детальными описаниями на русском
- **DataForm.cpp** - улучшена функция `ProcessResponse()` и команды `SendStartCommand()`/`SendStopCommand()`

---

## Дополнительные материалы

- **PROTOCOL_README.md** - описание протокола команд
- **CONTROLLER_PROTOCOL_USAGE.md** - примеры использования протокола
- **RESPONSE_HANDLING_GUIDE.md** - руководство по обработке ответов

---

**Версия**: 1.0  
**Дата**: 26 октября 2025  
**Проект**: ProjectServerW - Defrost Control System

