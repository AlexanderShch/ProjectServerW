# Фоновое сохранение в Excel при закрытии соединения

## Проблема

При закрытии соединения клиентом возникала следующая последовательность событий:

1. Клиент закрывает соединение (18:20:07)
2. Начинается запись данных в Excel (занимает ~2 минуты)
3. **Форма остается в списке активных форм** во время записи
4. Клиент пытается переподключиться (18:22:02)
5. Сервер отклоняет новое соединение, так как находит старую форму в `FindFormByClientIP`
6. Попытки подключения повторяются каждую секунду

### Пример из лога:
```
28.10.25 18:20:07 : Attention: Connection closed by client
28.10.25 18:20:07 : DataForm will be closed!
28.10.25 18:20:07 : Сохранение данных в Excel... WorkData_2025-10-28_16-55-26_Port8866
28.10.25 18:22:02 : Information: New thread was created, port 8866
28.10.25 18:22:02 : Внимание: Уже существует активное соединение от клиента 10.25.99.112. Новое соединение не будет создано.
```

## Решение

Изменена логика закрытия формы в `DataForm_FormClosing`:

### Было:
1. Блокировать закрытие формы (`e->Cancel = true`)
2. Запустить запись в Excel в отдельном потоке
3. **ЖДАТЬ** завершения записи (до 60 минут)
4. Закрыть форму (`e->Cancel = false`)

### Стало:
1. Запустить запись в Excel в отдельном потоке
2. **НЕМЕДЛЕННО закрыть форму** (`e->Cancel = false`)
3. Запись в Excel продолжается в фоновом режиме

## Изменения в коде

### DataForm.cpp - DataForm_FormClosing

```cpp
System::Void ProjectServerW::DataForm::DataForm_FormClosing(...) {
    try {
        // Проверяем, есть ли данные в таблице
        if (dataTable != nullptr && dataTable->Rows->Count > 0) {
            // Создаем имя файла, если оно еще не создано
            if (excelFileName == nullptr) {
                DateTime now = DateTime::Now;
                excelFileName = "EmergencyData_" + now.ToString("yyyy-MM-dd_HH-mm-ss") + 
                               "_Port" + clientPort.ToString() + ".xlsx";
            }

            // Логируем начало сохранения
            GlobalLogger::LogMessage("Сохранение данных в Excel (в фоновом режиме)... " + 
                                   ConvertToStdString(excelFileName));

            // Запускаем запись в Excel в отдельном потоке
            // Форма закроется сразу, не дожидаясь завершения записи
            DataForm::TriggerExcelExport();
            
            // НЕ ЖДЁМ завершения записи - форма закрывается сразу
            // Это позволяет клиенту переподключиться немедленно
            GlobalLogger::LogMessage("Information: Форма закрывается, запись в Excel продолжается в фоновом режиме");
        }
        
        // Разрешаем закрытие формы немедленно
        e->Cancel = false;
    }
    catch (Exception^ ex) {
        GlobalLogger::LogMessage("Ошибка при попытке сохранения данных: " + 
                               ConvertToStdString(ex->Message));
        e->Cancel = false;
    }
}
```

### DataForm.cpp - AddDataToExcel

Добавлены дополнительные проверки перед обращением к UI-элементам:

```cpp
// Обновляем текстовое поле, если оно существует и форма не закрыта
if (textBoxExcelDirectory != nullptr && !textBoxExcelDirectory->IsDisposed && 
    !this->IsDisposed && this->IsHandleCreated) {
    try {
        if (textBoxExcelDirectory->InvokeRequired) {
            textBoxExcelDirectory->BeginInvoke(gcnew System::Action<String^>(
                this, &DataForm::UpdateDirectoryTextBox), filePath);
        }
        else {
            textBoxExcelDirectory->Text = filePath;
        }
    }
    catch (...) {
        // Форма закрыта во время обновления - игнорируем
    }
}
```

## Преимущества

1. **Быстрое переподключение**: Клиент может переподключиться сразу после разрыва соединения
2. **Надежность**: Данные все равно сохраняются в Excel, даже если форма закрыта
3. **Многопоточность**: Запись в Excel выполняется в отдельном STA-потоке
4. **Безопасность**: Все обращения к UI защищены проверками на существование формы

## Поток выполнения

```
Клиент закрывает соединение
        |
        v
DataForm_FormClosing вызывается
        |
        +---> Создать имя файла (если нужно)
        +---> TriggerExcelExport() - запуск фонового потока
        +---> e->Cancel = false - разрешить закрытие
        |
        v
Форма закрывается НЕМЕДЛЕННО
Удаляется из formData_Map
        |
        v
Клиент может переподключиться
Создается НОВАЯ форма
        |
        v
                    [Параллельно]
                    Фоновый поток:
                    - Копирует DataTable
                    - Создает Excel файл
                    - Записывает данные
                    - Сохраняет файл
                    - Завершается
```

## Важные детали

1. **Копия данных**: `AddDataToExcel` создает копию `DataTable` в самом начале, поэтому закрытие формы не влияет на данные

2. **STA поток**: Excel COM-объекты требуют STA (Single-Threaded Apartment), поэтому создается отдельный STA-поток

3. **Проверки UI**: Все обращения к UI-элементам защищены проверками:
   - `!this->IsDisposed`
   - `this->IsHandleCreated`
   - `this->Visible`
   - try-catch блоками

4. **Сборка мусора**: После завершения записи вызывается отложенная сборка мусора для освобождения COM-объектов

## Тестирование

1. Подключить клиента
2. Собрать данные
3. Разорвать соединение
4. Немедленно попытаться переподключиться
5. Проверить, что:
   - Новое соединение принимается
   - Старый файл Excel успешно сохраняется
   - Новая форма начинает собирать данные

## Примечания

- Время записи Excel зависит от объема данных (обычно 30-120 секунд)
- Максимальное время ожидания записи удалено (раньше было 60 минут)
- Форма закрывается всегда, независимо от успеха записи Excel

