# Исправление дублирующей записи в Excel при потере связи

## Проблема

При потере связи с клиентом (таймаут recv 30 минут) выполнялась **дублирующая запись** в Excel файл:

1. ? **Первая запись** - корректная, по переходу бита Work из 1 в 0 (после 60 секунд в нуле)
2. ? **Вторая запись** - дублирующая, при закрытии формы DataForm из-за потери связи

### Симптомы:

```
12.11.25 01:46:43 : СТОП фиксации данных, запись в файл WorkData_...
12.11.25 01:46:43 : Записано 450 строк

[Потеря связи через 30 минут]

12.11.25 02:16:43 : Сохранение данных в Excel (в фоновом режиме)...
12.11.25 02:16:45 : Записано 450 строк  ? ДУБЛИКАТ! Те же данные
```

**Результат:** Создавались 2 одинаковых файла с одними и теми же данными.

---

## Причина

В обработчике `DataForm_FormClosing` не было проверки, были ли данные **уже экспортированы** в Excel. При закрытии формы (из-за потери связи) всегда выполнялась запись, даже если данные уже были сохранены по биту Work.

---

## Решение

Добавлен флаг **`dataExportedToExcel`**, который отслеживает состояние экспорта данных.

### Изменения в DataForm.h

**Добавлен новый флаг (строка 85):**

```cpp
bool dataExportedToExcel;  // флаг "данные уже были экспортированы в Excel"
```

**Инициализация в конструкторе (строка 149):**

```cpp
dataExportedToExcel = false;  // Флаг экспорта данных в Excel
```

---

### Изменения в DataForm.cpp

#### 1. Установка флага при успешном экспорте

**При экспорте по биту Work (строка 434):**

```cpp
// Устанавливаем флаг, что данные экспортированы
dataExportedToExcel = true;

// Выполняем запись в Excel
this->BeginInvoke(gcnew MethodInvoker(this, &DataForm::TriggerExcelExport));
```

**При экспорте по таймеру (строка 1633):**

```cpp
// Устанавливаем флаг, что данные экспортированы
dataExportedToExcel = true;

// Выполняем запись в Excel
this->BeginInvoke(gcnew MethodInvoker(this, &DataForm::TriggerExcelExport));
```

#### 2. Сброс флага при новом запуске работы

**При старте нового цикла сбора данных (строка 391):**

```cpp
// Сбрасываем флаги при новом запуске работы
workBitZeroLogged = false;
dataExportedToExcel = false;  // Новый цикл - данные еще не экспортированы
```

#### 3. Проверка флага в DataForm_FormClosing

**Обработчик закрытия формы (строки 1010-1033):**

```cpp
// Проверяем флаг: были ли данные уже записаны в Excel
if (dataExportedToExcel) {
    // Данные уже были экспортированы - не дублируем запись
    GlobalLogger::LogMessage("Information: Данные уже были экспортированы в Excel, повторная запись не требуется");
}
else {
    // Данные НЕ были экспортированы - это аварийное сохранение
    GlobalLogger::LogMessage("АВАРИЙНОЕ сохранение данных в Excel (потеря связи)...");
    DataForm::TriggerExcelExport();
}
```

---

## Логика работы флага

| Событие | Состояние флага | Действие |
|---------|----------------|----------|
| ?? Старт нового цикла (Work: 0?1) | `false` | Сброс флага |
| ?? Работа продолжается (Work = 1) | `false` | Данные накапливаются |
| ?? Остановка (Work: 1?0, 60 сек) | `true` ? ? **Экспорт** | Запись в Excel |
| ?? Потеря связи | `true` | ? Дубликат **НЕ создаётся** |
| ?? Аварийное закрытие (без экспорта) | `false` | ? **Экспорт** (аварийный) |

---

## Сценарии работы

### Сценарий 1: Нормальная работа (без потери связи)

```
01:00:00  Work: 0?1  (СТАРТ)         dataExportedToExcel = false
01:05:00  Work: 1?0  (СТОП, 60 сек)  dataExportedToExcel = true ? Экспорт ?
01:06:00  Пользователь закрывает форму  "Данные уже экспортированы" ?
```

**Результат:** 1 файл Excel

---

### Сценарий 2: Потеря связи после экспорта

```
11.11.25 16:48:47  Work: 0?1  (СТАРТ)         dataExportedToExcel = false
12.11.25 01:45:43  Work: 1?0  (СТОП, 60 сек)  dataExportedToExcel = true ? Экспорт ?
12.11.25 02:18:47  [Таймаут recv 30 мин]      "Данные уже экспортированы" ?
```

**Результат:** 1 файл Excel ? (дубликат **НЕ создаётся**)

---

### Сценарий 3: Аварийное сохранение (потеря связи ДО экспорта)

```
01:00:00  Work: 0?1  (СТАРТ)         dataExportedToExcel = false
01:05:00  [Клиент отключился]        dataExportedToExcel = false
01:05:00  Форма закрывается          "АВАРИЙНОЕ сохранение" ? Экспорт ?
```

**Результат:** 1 файл Excel (аварийное сохранение)

---

### Сценарий 4: Мигание бита Work (кратковременные остановки)

```
01:00:00  Work: 0?1  (СТАРТ)         dataExportedToExcel = false
01:05:00  Work: 1?0?1  (< 60 сек)    dataExportedToExcel = false (без экспорта)
01:10:00  Work: 1?0?1  (< 60 сек)    dataExportedToExcel = false (без экспорта)
01:15:00  Work: 1?0  (СТОП, 60 сек)  dataExportedToExcel = true ? Экспорт ?
```

**Результат:** 1 файл Excel

---

## Преимущества решения

? **Исключены дублирующие записи** при потере связи  
? **Сохранена защита данных** - аварийное сохранение при неожиданных закрытиях  
? **Улучшено логирование** - понятно, когда выполняется аварийное сохранение  
? **Минимальные изменения кода** - добавлен только один флаг  

---

## Тестирование

### Тест 1: Нормальная работа
1. Запустить работу (бит Work: 0?1)
2. Остановить работу (бит Work: 1?0, ждать 60 сек)
3. Проверить, что создался 1 файл Excel
4. Закрыть форму
5. **Ожидается:** Второй файл НЕ создаётся

### Тест 2: Потеря связи после экспорта
1. Запустить работу (бит Work: 0?1)
2. Остановить работу (бит Work: 1?0, ждать 60 сек)
3. Отключить клиент (имитация потери связи)
4. **Ожидается:** В логе "Данные уже были экспортированы", дубликат НЕ создаётся

### Тест 3: Аварийное сохранение
1. Запустить работу (бит Work: 0?1)
2. Отключить клиент ДО остановки работы
3. **Ожидается:** В логе "АВАРИЙНОЕ сохранение", файл создаётся

---

## Файлы изменений

| Файл | Изменения |
|------|-----------|
| `DataForm.h` | Добавлен флаг `dataExportedToExcel` (строки 85, 149) |
| `DataForm.cpp` | Установка флага (строки 391, 434, 1633) |
| `DataForm.cpp` | Проверка флага в `DataForm_FormClosing` (строки 1010-1033) |

---

## Дата внедрения

12 ноября 2025 г.

