# Исправления от 11 ноября 2025 года

## Проблема 1: Избыточное логирование при мигании лампы СТАРТ

### Описание проблемы
При остановке работы контроллера бит Work начинает "мигать" (переключаться между 0 и 1) в течение минуты. Каждое переключение логировалось, создавая множество записей в лог-файле:
- "Information: Бит Work стал нулём, начато отслеживание времени..."
- "Information: СТАРТ фиксации данных, создано имя файла..."

Это создавало десятки ненужных записей в лог-файле.

### Решение
Добавлен флаг `workBitZeroLogged` для отслеживания того, было ли уже залогировано сообщение о начале отслеживания нуля.

Теперь логика работает так:
1. **Первый переход 1?0**: Логируется сообщение "Бит Work стал нулём, начато отслеживание времени...", устанавливается флаг `workBitZeroLogged = true`
2. **Мигание (переходы 0?1 во время таймера)**: НЕ логируются, только сбрасывается таймер отслеживания
3. **Финальный СТОП (через 60 секунд)**: Логируется "СТОП фиксации данных (по таймеру), запись в файл...", флаг сбрасывается

### Изменённые файлы
- `DataForm.h`: Добавлен флаг `bool workBitZeroLogged`
- `DataForm.cpp`: Изменена логика обработки бита Work (строки 363-405, 407-426, 1596-1611)

---

## Проблема 2: Программа не принимает новое соединение после разрыва связи

### Описание проблемы
После разрыва соединения (например, при переподключении контроллера), сервер не мог принять новое соединение от того же клиента, выдавая сообщение:
> "Внимание: Уже существует активное соединение от клиента X.X.X.X. Новое соединение не будет создано."

Причина: форма DataForm удалялась из карты `formData_Map` только в событии `FormClosed`, которое происходит с задержкой. За это время новое соединение успевало проверить карту и находило "старую" форму.

### Решение
Форма теперь удаляется из карты `formData_Map` **немедленно** в функции `CloseForm()`, до вызова `form->Close()`. Это позволяет новым соединениям от того же клиента создавать новые формы немедленно.

### Изменённые файлы
- `DataForm.cpp`: 
  - Функция `CloseForm()` (строки 150-175): Добавлено удаление формы из карты до закрытия
  - Функция `DataForm_FormClosed()` (строки 1032-1058): Добавлена проверка на наличие формы в карте

---

## Результат
1. ? Лог-файл теперь чистый - нет повторяющихся сообщений о мигании лампы
2. ? Сервер корректно принимает новые соединения сразу после разрыва старого соединения
3. ? Excel-файлы продолжают записываться в фоновом режиме без блокировки новых соединений

## Тестирование
Рекомендуется протестировать:
1. Запуск и остановку контроллера - проверить, что в логе только одна запись о начале отслеживания и одна о СТОП
2. Переподключение контроллера - проверить, что новое соединение принимается немедленно
3. Разрыв соединения во время работы - проверить, что Excel сохраняется и новое соединение принимается

