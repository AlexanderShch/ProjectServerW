# Настройки таймаутов и обработка потери соединения

## Текущие настройки таймаутов

### 1. Таймаут операции recv() - **30 минут**

**Местоположение:** `SServer.cpp`, строка 264

```cpp
int timeout = 30*60*1000;  // Тайм-аут в миллисекундах (1000 мс = 1 секунда)
```

**Значение:** 30 ? 60 ? 1000 = **1 800 000 мс = 30 минут**

**Описание:** Если от клиента не приходит ни одного байта данных в течение 30 минут, соединение автоматически разрывается.

### 2. Таймаут ожидания ответа на команды - **2 секунды**

**Местоположение:** `DataForm.cpp`, строка 1431

```cpp
if (!ReceiveResponse(response, 2000)) { // Таймаут 2 секунды
```

**Значение:** 2000 мс = **2 секунды**

**Описание:** При отправке команд контроллеру (START/STOP/RESET) ожидание ответа составляет 2 секунды.

### 3. Таймаут для экспорта в Excel - **60 минут**

**Местоположение:** `DataForm.cpp`, строка 897

```cpp
if (exportCompletedEvent->WaitOne(60*60*1000)) { // 60 минут ожидания на запись файла
```

**Значение:** 60 ? 60 ? 1000 = **3 600 000 мс = 60 минут**

**Описание:** Максимальное время ожидания завершения записи Excel файла при закрытии формы.

---

## Поведение при потере соединения

### Сценарий 1: Клиент отключается (нормальное закрытие)

**Последовательность событий:**
1. Функция `recv()` возвращает `0` (соединение закрыто клиентом)
2. Выводится сообщение: `"Attention: Connection closed by client"`
3. Закрывается сокет: `closesocket(clientSocket)`
4. **Автоматически закрывается форма DataForm**: `DataForm::CloseForm(guid)`
5. Останавливается поток обработки: `ThreadStorage::StopThread(guid)`

**Время до закрытия формы:** **Мгновенно** (как только клиент закроет соединение)

### Сценарий 2: Потеря связи (таймаут recv)

**Последовательность событий:**
1. В течение 30 минут от клиента не приходит данных
2. Функция `recv()` возвращает `SOCKET_ERROR` с кодом `WSAETIMEDOUT`
3. Выводится сообщение: `"Attention: Recv timed out"`
4. Закрывается сокет: `closesocket(clientSocket)`
5. **Автоматически закрывается форма DataForm**: `DataForm::CloseForm(guid)`
6. Останавливается поток обработки: `ThreadStorage::StopThread(guid)`

**Время до закрытия формы:** **30 минут** (после последнего полученного пакета)

### Сценарий 3: Ошибка recv (например, сетевая ошибка)

**Последовательность событий:**
1. Функция `recv()` возвращает `SOCKET_ERROR` с кодом ошибки (не `WSAETIMEDOUT`)
2. Выводится сообщение: `"Attention: Recv failed: [код ошибки]"`
3. Закрывается сокет: `closesocket(clientSocket)`
4. **Автоматически закрывается форма DataForm**: `DataForm::CloseForm(guid)`
5. Останавливается поток обработки: `ThreadStorage::StopThread(guid)`

**Время до закрытия формы:** **Мгновенно** (при возникновении ошибки)

---

## Код обработки (SServer.cpp, строки 292-313)

```cpp
if (bytesReceived == SOCKET_ERROR) {
    int error = WSAGetLastError();
    if (error == WSAETIMEDOUT) {
        if (form != nullptr && !form->IsDisposed) {
            form->SetMessage_TextValue("Attention: Recv timed out");
            GlobalLogger::LogMessage("Attention: Recv timed out");
        }
    }
    else {
        if (form != nullptr && !form->IsDisposed) {
            form->SetMessage_TextValue("Attention: Recv failed: " + error);
            GlobalLogger::LogMessage(ConvertToStdString("Attention: Recv failed: " + error));
        }
    }
    break;	// Выходим из цикла
}
if (bytesReceived == 0) {
    if (form != nullptr && !form->IsDisposed) {
        form->SetMessage_TextValue("Attention: Connection closed by client");
        GlobalLogger::LogMessage("Attention: Connection closed by client");
    }
    break;	// Выходим из цикла
}
```

## Код закрытия формы (SServer.cpp, строки 538-544)

```cpp
exitMainLoop:  // Метка для выхода из всех циклов
    // Цикл приёма данных прерван по ошибке приёма, закрываем форму приёма данных
    closesocket(clientSocket);
    // Найдём форму данных по идентификатору и закроем её
    DataForm::CloseForm(guid);
    // Закрытие потока формы данных по guid формы
    ThreadStorage::StopThread(guid);
```

---

## Рекомендации по изменению таймаута

### Как изменить таймаут recv (текущее значение: 30 минут)

**Файл:** `SServer.cpp`, строка 264

**Варианты:**

| Время | Значение (мс) | Применение |
|-------|---------------|------------|
| 1 минута | 60 * 1000 = 60000 | Для быстрого тестирования |
| 5 минут | 5 * 60 * 1000 = 300000 | Для стабильных соединений |
| 10 минут | 10 * 60 * 1000 = 600000 | Умеренное ожидание |
| 30 минут | 30 * 60 * 1000 = 1800000 | **Текущее** (по умолчанию) |
| 1 час | 60 * 60 * 1000 = 3600000 | Для длительных соединений |
| Без таймаута | 0 | Бесконечное ожидание (не рекомендуется) |

**Пример изменения на 5 минут:**

```cpp
int timeout = 5*60*1000;  // 5 минут
```

### ?? Важные замечания

1. **Не устанавливайте слишком короткий таймаут** (< 1 минуты), иначе при кратковременных сетевых проблемах формы будут закрываться.

2. **Не устанавливайте таймаут = 0** (бесконечное ожидание), так как "зависшие" соединения будут занимать ресурсы сервера.

3. **Рекомендуемый диапазон:** от 5 до 30 минут в зависимости от стабильности сети.

4. **При изменении таймаута необходимо:** перекомпилировать проект и перезапустить приложение.

---

## Вопросы и ответы

### Q: Можно ли не закрывать форму DataForm при потере соединения?

**A:** Да, можно закомментировать строку 542 в `SServer.cpp`:

```cpp
// DataForm::CloseForm(guid);  // Закомментировано - форма останется открытой
```

Но это **не рекомендуется**, так как:
- Форма будет "мертвой" (не будет принимать данные)
- Пользователю придется закрывать её вручную
- При переподключении клиента откроется новая форма

### Q: Как изменить поведение, чтобы форма оставалась открытой, но показывала предупреждение?

**A:** Можно изменить код в `SServer.cpp`, строки 540-542:

```cpp
closesocket(clientSocket);
// Вместо закрытия формы, показываем предупреждение
if (form != nullptr && !form->IsDisposed) {
    form->SetData_TextValue("?? Соединение потеряно. Форма будет закрыта через 30 секунд...");
    System::Threading::Thread::Sleep(30000);  // Ждём 30 секунд
}
DataForm::CloseForm(guid);
```

### Q: Можно ли настроить разные таймауты для разных клиентов?

**A:** Да, можно передать таймаут как параметр в функцию `ReceiveFromClient()` и устанавливать его динамически для каждого клиента.

---

## Итоговая таблица

| Событие | Время до закрытия формы | Автоматическое закрытие |
|---------|-------------------------|-------------------------|
| Клиент отключился | Мгновенно | ? Да |
| Таймаут recv (нет данных 30 мин) | 30 минут | ? Да |
| Сетевая ошибка | Мгновенно | ? Да |
| Ручное закрытие (меню "Выход") | Мгновенно | ?? По запросу пользователя |

---

## Дата создания документа

11 ноября 2025 г.

